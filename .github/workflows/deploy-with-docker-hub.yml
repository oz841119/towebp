name: Build and Deploy via Docker Hub

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/towebp
  DOCKER_TAG: latest

jobs:
  build-and-push:
    name: å»ºç½®ä¸¦æ¨é€åˆ° Docker Hub
    runs-on: ubuntu-latest
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å…¥ Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: å»ºç½®ä¸¦æ¨é€ Docker æ˜ åƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max

  deploy:
    name: éƒ¨ç½²åˆ° VPS
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: éƒ¨ç½²åˆ° VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            # é€²å…¥å°ˆæ¡ˆç›®éŒ„
            cd ${{ secrets.VPS_PROJECT_PATH || '/opt/towebp' }}
            
            # æ‹‰å–æœ€æ–°æ˜ åƒ
            echo "ğŸ“¥ æ‹‰å–æœ€æ–° Docker æ˜ åƒ..."
            docker pull ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
            
            # åœæ­¢ä¸¦ç§»é™¤èˆŠå®¹å™¨
            echo "ğŸ›‘ åœæ­¢èˆŠå®¹å™¨..."
            docker-compose down
            
            # å•Ÿå‹•æ–°å®¹å™¨
            echo "ğŸš€ å•Ÿå‹•æ–°å®¹å™¨..."
            docker-compose up -d
            
            # æ¸…ç†æœªä½¿ç”¨çš„æ˜ åƒ
            echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„ Docker æ˜ åƒ..."
            docker image prune -f
            
            # é¡¯ç¤ºå®¹å™¨ç‹€æ…‹
            echo "âœ… éƒ¨ç½²å®Œæˆï¼å®¹å™¨ç‹€æ…‹ï¼š"
            docker-compose ps
            
            # é¡¯ç¤ºæœ€è¿‘çš„æ—¥èªŒ
            echo "ğŸ“‹ æœ€è¿‘çš„æ—¥èªŒï¼š"
            docker-compose logs --tail=50

      - name: å¥åº·æª¢æŸ¥
        run: |
          echo "ğŸ¥ ç­‰å¾…æœå‹™å•Ÿå‹•..."
          sleep 10
          
          # é€™è£¡å¯ä»¥æ·»åŠ å¥åº·æª¢æŸ¥é‚è¼¯
          # curl -f http://${{ secrets.VPS_HOST }}:3001 || exit 1

      - name: é€šçŸ¥éƒ¨ç½²çµæœ
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          else
            echo "âŒ éƒ¨ç½²å¤±æ•—ï¼"
          fi
