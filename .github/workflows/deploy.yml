name: Deploy to VPS

on:
  push:
    branches:
      - main  # 當推送到 main 分支時觸發
  workflow_dispatch:  # 允許手動觸發

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: 檢出代碼
        uses: actions/checkout@v4

      - name: 部署到 VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            # 進入專案目錄
            cd ${{ secrets.VPS_PROJECT_PATH || '/opt/towebp' }}
            
            # 檢測 Docker Compose 版本並設定命令
            if command -v docker-compose &> /dev/null; then
              DOCKER_COMPOSE="docker-compose"
              echo "✅ 使用 Docker Compose V1"
            elif docker compose version &> /dev/null; then
              DOCKER_COMPOSE="docker compose"
              echo "✅ 使用 Docker Compose V2"
            else
              echo "❌ 錯誤：未找到 Docker Compose"
              echo "請在 VPS 上安裝 Docker Compose"
              exit 1
            fi
            
            # 拉取最新代碼
            echo "📥 拉取最新代碼..."
            git pull origin main
            
            # 複製環境變數（如果不存在）
            if [ ! -f .env.local ]; then
              echo "⚙️ 創建環境變數檔案..."
              cp .env.local.example .env.local
              echo "⚠️ 請記得編輯 .env.local 設定正確的環境變數"
            fi
            
            # 使用 Docker Compose 重新建置和啟動
            echo "🐳 重新建置 Docker 容器..."
            $DOCKER_COMPOSE down
            $DOCKER_COMPOSE build --no-cache
            $DOCKER_COMPOSE up -d
            
            # 清理未使用的 Docker 映像
            echo "🧹 清理未使用的 Docker 映像..."
            docker image prune -f
            
            # 顯示容器狀態
            echo "✅ 部署完成！容器狀態："
            $DOCKER_COMPOSE ps
            
            # 顯示最近的日誌
            echo "📋 最近的日誌："
            $DOCKER_COMPOSE logs --tail=50

      - name: 通知部署結果
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ 部署成功！"
          else
            echo "❌ 部署失敗！"
          fi
