name: Deploy to VPS

on:
  push:
    branches:
      - main  # ç•¶æ¨é€åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: éƒ¨ç½²åˆ° VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            # é€²å…¥å°ˆæ¡ˆç›®éŒ„
            cd ${{ secrets.VPS_PROJECT_PATH || '/opt/towebp' }}
            
            # æ‹‰å–æœ€æ–°ä»£ç¢¼
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç¢¼..."
            git pull origin main
            
            # è¤‡è£½ç’°å¢ƒè®Šæ•¸ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if [ ! -f .env.local ]; then
              echo "âš™ï¸ å‰µå»ºç’°å¢ƒè®Šæ•¸æª”æ¡ˆ..."
              cp .env.local.example .env.local
              echo "âš ï¸ è«‹è¨˜å¾—ç·¨è¼¯ .env.local è¨­å®šæ­£ç¢ºçš„ç’°å¢ƒè®Šæ•¸"
            fi
            
            # ä½¿ç”¨ Docker Compose é‡æ–°å»ºç½®å’Œå•Ÿå‹•
            echo "ğŸ³ é‡æ–°å»ºç½® Docker å®¹å™¨..."
            docker-compose down
            docker-compose build --no-cache
            docker-compose up -d
            
            # æ¸…ç†æœªä½¿ç”¨çš„ Docker æ˜ åƒ
            echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„ Docker æ˜ åƒ..."
            docker image prune -f
            
            # é¡¯ç¤ºå®¹å™¨ç‹€æ…‹
            echo "âœ… éƒ¨ç½²å®Œæˆï¼å®¹å™¨ç‹€æ…‹ï¼š"
            docker-compose ps
            
            # é¡¯ç¤ºæœ€è¿‘çš„æ—¥èªŒ
            echo "ğŸ“‹ æœ€è¿‘çš„æ—¥èªŒï¼š"
            docker-compose logs --tail=50

      - name: é€šçŸ¥éƒ¨ç½²çµæœ
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          else
            echo "âŒ éƒ¨ç½²å¤±æ•—ï¼"
          fi
